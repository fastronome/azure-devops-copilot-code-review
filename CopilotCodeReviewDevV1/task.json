{
    "$schema": "https://raw.githubusercontent.com/Microsoft/azure-pipelines-task-lib/master/tasks.schema.json",
    "id": "a453b724-76f0-496b-9b62-012beaf9a0ea",
    "name": "CopilotCodeReviewDev",
    "friendlyName": "Fastronome Copilot Code Review (Dev)",
    "description": "[Development Build] Perform automated code reviews on pull requests using the official GitHub Copilot CLI",
    "helpMarkDown": "[Learn more about this task](https://github.com/fastronome/azure-devops-copilot-code-review)",
    "category": "Utility",
    "author": "Fastronome",
    "version": {
        "Major": 1,
        "Minor": 5,
        "Patch": 4
    },
    "instanceNameFormat": "Fastronome Copilot Code Review (Dev)",
    "minimumAgentVersion": "2.182.1",
    "inputs": [
        {
            "name": "githubPat",
            "type": "string",
            "label": "GitHub PAT",
            "required": true,
            "helpMarkDown": "Personal Access Token for GitHub with Copilot access. This token is used to authenticate with the GitHub Copilot CLI."
        },
        {
            "name": "azureDevOpsPat",
            "type": "string",
            "label": "Azure DevOps PAT",
            "required": false,
            "helpMarkDown": "Personal Access Token for Azure DevOps. Used for retrieving pull request details and posting review comments. **Required for Azure DevOps Server (on-prem)**. For Azure DevOps Services (cloud), you can use the System Access Token instead by enabling the option below."
        },
        {
            "name": "useSystemAccessToken",
            "type": "boolean",
            "label": "Use System Access Token",
            "required": false,
            "defaultValue": false,
            "helpMarkDown": "When enabled, uses the pipeline's System.AccessToken (OAuth) instead of a PAT. This is the Microsoft-recommended authentication method for Azure DevOps Services. **Note**: The Build Service identity must have 'Contribute to pull requests' permission on the repository. Not supported for Azure DevOps Server (on-prem)."
        },
        {
            "name": "organization",
            "type": "string",
            "label": "Organization",
            "required": false,
            "defaultValue": "",
            "helpMarkDown": "The Azure DevOps organization name for cloud-hosted instances (e.g., 'myorg' from https://dev.azure.com/myorg). For Azure DevOps Server (on-prem), use 'collectionUri' instead. If neither is specified, auto-detected from the pipeline context."
        },
        {
            "name": "collectionUri",
            "type": "string",
            "label": "Collection URI",
            "required": false,
            "defaultValue": "",
            "helpMarkDown": "The full Azure DevOps collection URI (e.g., 'https://dev.azure.com/myorg', 'https://tfs.contoso.com/tfs/DefaultCollection'). If not specified, will be automatically detected from System.CollectionUri. Use this for Azure DevOps Server (on-prem) installations."
        },
        {
            "name": "project",
            "type": "string",
            "label": "Project",
            "required": false,
            "defaultValue": "$(System.TeamProject)",
            "helpMarkDown": "The Azure DevOps project name. Defaults to $(System.TeamProject)."
        },
        {
            "name": "repository",
            "type": "string",
            "label": "Repository",
            "required": false,
            "defaultValue": "$(Build.Repository.Name)",
            "helpMarkDown": "The repository name where the pull request exists. Defaults to $(Build.Repository.Name)."
        },
        {
            "name": "pullRequestId",
            "type": "string",
            "label": "Pull Request ID",
            "required": false,
            "defaultValue": "",
            "helpMarkDown": "The ID of the pull request to review. If not specified, defaults to $(System.PullRequest.PullRequestId) when run as part of a PR validation build."
        },
        {
            "name": "timeout",
            "type": "string",
            "label": "Timeout (minutes)",
            "required": false,
            "defaultValue": "15",
            "helpMarkDown": "The maximum number of minutes to allow the Copilot review to run before timing out. Default is 15 minutes."
        },
        {
            "name": "model",
            "type": "string",
            "label": "Copilot Model",
            "required": false,
            "defaultValue": "",
            "helpMarkDown": "Optional. The Copilot model to use for the review (e.g., 'gpt-4', 'claude-sonnet'). If not specified, uses the default model."
        },
        {
            "name": "reviewBugs",
            "type": "boolean",
            "label": "Check for bugs",
            "required": false,
            "defaultValue": true,
            "helpMarkDown": "Enable bug-focused review guidance in the generated Copilot prompt. Default value is `true`."
        },
        {
            "name": "reviewPerformance",
            "type": "boolean",
            "label": "Check for performance problems",
            "required": false,
            "defaultValue": true,
            "helpMarkDown": "Enable performance-focused review guidance in the generated Copilot prompt. Default value is `true`."
        },
        {
            "name": "reviewBestPractices",
            "type": "boolean",
            "label": "Check for missed best practices",
            "required": false,
            "defaultValue": true,
            "helpMarkDown": "Enable best-practices review guidance in the generated Copilot prompt. Default value is `true`."
        },
        {
            "name": "reviewWholeDiffAtOnce",
            "type": "boolean",
            "label": "Review whole diff at once",
            "required": false,
            "defaultValue": false,
            "helpMarkDown": "When enabled, the prompt instructs Copilot to produce a single consolidated PR-level review with a summary and file status table, similar to the Fastronome AI Code Review task."
        },
        {
            "name": "additionalPrompts",
            "type": "multiLine",
            "label": "Additional Prompts",
            "required": false,
            "defaultValue": "",
            "helpMarkDown": "Optional extra review instructions. You can provide comma-separated and/or newline-separated directives that will be appended to the generated review behavior prompt.",
            "properties": {
                "rows": "6",
                "maxLength": "5000"
            }
        },
        {
            "name": "promptFile",
            "type": "filePath",
            "label": "Custom Prompt File",
            "required": false,
            "defaultValue": "",
            "helpMarkDown": "Optional. Path to a .txt file containing a custom prompt for Copilot. The file must exist and contain content."
        },
        {
            "name": "prompt",
            "type": "multiLine",
            "label": "Custom Prompt",
            "required": false,
            "defaultValue": "",
            "helpMarkDown": "Optional. A custom prompt to pass directly to Copilot. If both prompt and promptFile are specified, prompt takes precedence.",
            "properties": {
                "rows": "10",
                "maxLength": "5000"
            }
        },
        {
            "name": "promptRaw",
            "type": "multiLine",
            "label": "Raw Prompt",
            "required": false,
            "defaultValue": "",
            "helpMarkDown": "Optional. A raw prompt to pass directly to the Copilot CLI with no modification. Cannot be combined with other prompt inputs (prompt, promptFile, promptFileRaw).",
            "properties": {
                "rows": "10",
                "maxLength": "5000"
            }
        },
        {
            "name": "promptFileRaw",
            "type": "filePath",
            "label": "Raw Prompt File",
            "required": false,
            "defaultValue": "",
            "helpMarkDown": "Optional. Path to a file containing a raw prompt to pass directly to the Copilot CLI with no modification. Cannot be combined with other prompt inputs (prompt, promptFile, promptRaw)."
        },
        {
            "name": "authors",
            "type": "string",
            "label": "Author Filter",
            "required": false,
            "defaultValue": "",
            "helpMarkDown": "Optional. A comma-separated list of email addresses. If specified, the task will only run code reviews for PRs authored by users with matching email addresses. Uses $(Build.RequestedForEmail) for comparison."
        }
    ],
    "execution": {
        "Node20_1": {
            "target": "index.js"
        }
    },
    "restrictions": {
        "commands": {
            "mode": "restricted"
        },
        "settableVariables": {
            "allowed": []
        }
    }
}
